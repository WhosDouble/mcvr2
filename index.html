<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mcDemo</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aframe-blink-controls/dist/aframe-blink-controls.min.js"></script>
  </head>
  <body>
    <a-scene>
      <a-assets>
        <img id="groundTexture" src="assets/32_flagstone_tiles.png" />
        <img id="skyTexture" src="assets/clouds1_up.bmp" />
        <img
          src="assets/i-revamped-the-old-cobblestone-texture-from-alpha-and-beta-v0-gahxr15y241c1.png"
          id="cobblestoneTexture"
        />
        <img id="woodBlockTexture" src="assets/13530476-cover_l.jpg" />
        <img id="grassBlockTexture" src="assets/11635-v2.jpg" />
        <a-mixin
          id="cobblestoneBlock"
          geometry="primitive: box; height: 0.75; width: 0.75; depth: 0.75"
          material="src: #cobblestoneTexture"
        ></a-mixin>
        <a-mixin
          id="woodBlock"
          geometry="primitive: box; height: 0.75; width: 0.75; depth: 0.75"
          material="src: #woodBlockTexture"
        ></a-mixin>
        <a-mixin
          id="grassBlock"
          geometry="primitive: box; height: 0.75; width: 0.75; depth: 0.75"
          material="src: #grassBlockTexture"
        ></a-mixin>
      </a-assets>

      <a-cylinder
        id="ground"
        src="#groundTexture"
        radius="200"
        height="5"
      ></a-cylinder>
      <a-sky
        id="background"
        src="#skyTexture"
        theta-length="90"
        radius="500"
      ></a-sky>

      <a-entity id="player" position="0 1.6 0">
        <a-entity
          id="movmentHand"
          hand-controls="hand: left"
          blink-controls="cameraRig: #player"
        ></a-entity>
        <a-entity
          id="blockHand"
          hand-controls="hand: right"
          laser-controls
          raycaster="near: 0.5"
        ></a-entity>
        <a-camera position="0 0 0"></a-camera>
      </a-entity>
      <a-entity
        id="blockMenu"
        visible="false"
        position="0 1.5 -1"
        rotation="0 0 0"
      >
        <a-plane
          id="cobblestonePreview"
          mixin="cobblestoneBlock"
          position="-0.6 0 0"
          scale="0.5 0.5 0.5"
          class="selectable-block"
        ></a-plane>
        <a-plane
          id="woodPreview"
          mixin="woodBlock"
          position="0 0 0"
          scale="0.5 0.5 0.5"
          class="selectable-block"
        ></a-plane>
        <a-plane
          id="grassPreview"
          mixin="grassBlock"
          position="0.6 0 0"
          scale="0.5 0.5 0.5"
          class="selectable-block"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- âœ… Your working JS should go here -->
    <script>
      let blockSize = 0.75;
      let currentBlock = "cobbleStoneBlock"; // this should match your mixin id

      const player = document.querySelector("#player");
      const rightHand = document.querySelector("#blockHand");
      const blockMenu = document.querySelector("#blockMenu");
      const leftHand = document.querySelector("#movmentHand");

      rightHand.addEventListener("click", function (evt) {
        let newVoxelEl = document.createElement("a-entity");
        newVoxelEl.setAttribute("mixin", currentBlock);

        let normal = evt.detail.intersection.face.normal.clone();
        normal.multiplyScalar(blockSize);

        let position = evt.detail.intersection.point.clone();
        position.add(normal);

        // grid snap
        position.x = Math.round(position.x / blockSize) * blockSize;
        position.y = Math.round(position.y / blockSize) * blockSize;
        position.z = Math.round(position.z / blockSize) * blockSize;

        newVoxelEl.setAttribute("position", position);

        this.sceneEl.appendChild(newVoxelEl);
      });

      rightHand.addEventListener("abuttondown", () => {
        const menu = document.querySelector("#blockMenu");
        if (menu) {
          menu.object3D.visible = !menu.object3D.visible;
        }
      });

      rightHand.addEventListener("gripdown", () => {
        deleteTargetedBlock();
      });

      leftHand.addEventListener("axismove", (evt) => {
        if (!evt.detail || !evt.detail.axis) return; // safety check

        const [x, y] = evt.detail.axis; // thumbstick x,y
        if (x === 0 && y === 0) return; // no movement

        const speed = 0.05;
        const rotation = player.getAttribute("rotation").y || 0;

        const rad = THREE.MathUtils.degToRad(rotation);
        const forwardX = -Math.sin(rad);
        const forwardZ = -Math.cos(rad);
        const rightX = Math.cos(rad);
        const rightZ = -Math.sin(rad);

        const deltaX = rightX * x * speed + forwardX * y * speed;
        const deltaZ = rightZ * x * speed + forwardZ * y * speed;

        const pos = player.getAttribute("position");

        // Calculate next horizontal position
        const nextX = pos.x + deltaX;
        const nextZ = pos.z + deltaZ;
        const footHeight = pos.y;

        const stepHeight = 0.75; // max height player can step up

        const blocks = Array.from(document.querySelectorAll("[mixin]"));

        let canStepUp = false;
        let stepUpY = footHeight;

        for (const block of blocks) {
          const bPos = block.getAttribute("position");

          // Check horizontal proximity (allow some margin)
          const distX = Math.abs(bPos.x - nextX);
          const distZ = Math.abs(bPos.z - nextZ);

          if (distX < blockSize * 0.6 && distZ < blockSize * 0.6) {
            // Check if block top is within step height above player's feet
            const blockTopY = bPos.y + blockSize / 2;
            if (
              blockTopY <= footHeight + stepHeight &&
              blockTopY > footHeight
            ) {
              canStepUp = true;
              stepUpY = blockTopY;
              break; // found step-up block, no need to check further
            }
          }
        }

        if (canStepUp) {
          player.setAttribute("position", {
            x: nextX,
            y: stepUpY,
            z: nextZ,
          });
        } else {
          // Normal horizontal movement (no step up)
          player.setAttribute("position", {
            x: nextX,
            y: footHeight,
            z: nextZ,
          });
        }
      });

      blockMenu.querySelectorAll(".selectable-block").forEach((el) => {
        el.addEventListener("click", () => {
          currentBlock = el.getAttribute("mixin");
          blockMenu.object3D.visible = false;
        });
      });

      function deleteTargetedBlock() {
        const raycaster = rightHand.components.raycaster;

        if (!raycaster) return;

        const intersections = raycaster.intersections;
        if (intersections.length === 0) return;

        const intersectedEl = intersections[0].object.el;
        if (intersectedEl && intersectedEl.getAttribute("mixin")) {
          intersectedEl.parentNode.removeChild(intersectedEl);
        }
      }
    </script>
  </body>
</html>
